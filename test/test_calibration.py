import pytest
import argparse
import tempfile
import os
from fetchmgs import fetchmgs
from fetchmgs.test_config import *

def test_calibration():
    args = argparse.Namespace()
    hmms = {
        'COG0012': f'{PACKAGE_DIR}/data/COG0012.hmm',
        'COG0016': f'{PACKAGE_DIR}/data/COG0016.hmm',
        'COG0018': f'{PACKAGE_DIR}/data/COG0018.hmm',
        'COG0048': f'{PACKAGE_DIR}/data/COG0048.hmm',
        'COG0049': f'{PACKAGE_DIR}/data/COG0049.hmm',
        'COG0052': f'{PACKAGE_DIR}/data/COG0052.hmm',
        'COG0080': f'{PACKAGE_DIR}/data/COG0080.hmm',
        'COG0081': f'{PACKAGE_DIR}/data/COG0081.hmm',
        'COG0085': f'{PACKAGE_DIR}/data/COG0085.hmm',
        'COG0086': f'{PACKAGE_DIR}/data/COG0086.hmm',
        'COG0087': f'{PACKAGE_DIR}/data/COG0087.hmm',
        'COG0088': f'{PACKAGE_DIR}/data/COG0088.hmm',
        'COG0090': f'{PACKAGE_DIR}/data/COG0090.hmm',
        'COG0091': f'{PACKAGE_DIR}/data/COG0091.hmm',
        'COG0092': f'{PACKAGE_DIR}/data/COG0092.hmm',
        'COG0093': f'{PACKAGE_DIR}/data/COG0093.hmm',
        'COG0094': f'{PACKAGE_DIR}/data/COG0094.hmm',
        'COG0096': f'{PACKAGE_DIR}/data/COG0096.hmm',
        'COG0097': f'{PACKAGE_DIR}/data/COG0097.hmm',
        'COG0098': f'{PACKAGE_DIR}/data/COG0098.hmm',
        'COG0099': f'{PACKAGE_DIR}/data/COG0099.hmm',
        'COG0100': f'{PACKAGE_DIR}/data/COG0100.hmm',
        'COG0102': f'{PACKAGE_DIR}/data/COG0102.hmm',
        'COG0103': f'{PACKAGE_DIR}/data/COG0103.hmm',
        'COG0124': f'{PACKAGE_DIR}/data/COG0124.hmm',
        'COG0172': f'{PACKAGE_DIR}/data/COG0172.hmm',
        'COG0184': f'{PACKAGE_DIR}/data/COG0184.hmm',
        'COG0185': f'{PACKAGE_DIR}/data/COG0185.hmm',
        'COG0186': f'{PACKAGE_DIR}/data/COG0186.hmm',
        'COG0197': f'{PACKAGE_DIR}/data/COG0197.hmm',
        'COG0200': f'{PACKAGE_DIR}/data/COG0200.hmm',
        'COG0201': f'{PACKAGE_DIR}/data/COG0201.hmm',
        'COG0202': f'{PACKAGE_DIR}/data/COG0202.hmm',
        'COG0215': f'{PACKAGE_DIR}/data/COG0215.hmm',
        'COG0256': f'{PACKAGE_DIR}/data/COG0256.hmm',
        'COG0495': f'{PACKAGE_DIR}/data/COG0495.hmm',
        'COG0522': f'{PACKAGE_DIR}/data/COG0522.hmm',
        'COG0525': f'{PACKAGE_DIR}/data/COG0525.hmm',
        'COG0533': f'{PACKAGE_DIR}/data/COG0533.hmm',
        'COG0541': f'{PACKAGE_DIR}/data/COG0541.hmm',
        'COG0552': f'{PACKAGE_DIR}/data/COG0552.hmm'}
    results = {'COG0012': {'1089456.NCGM2_0913': 562.1, '1037409.BJ6T_18600': 543.8, '1148.SYNGTS_1374': 541.3,
                           '944546.ABED_0682': 520.7, '944547.ABLL_0922': 516.8, '1148.SYNGTS_0372': 80.4,
                           '944547.ABLL_2084': 77.0, '1037409.BJ6T_03900': 73.4, '1089456.NCGM2_1030': 73.1,
                           '944546.ABED_1492': 70.3, '1037409.BJ6T_57670': 61.0},
               'COG0016': {'1089456.NCGM2_3777': 479.6, '1037409.BJ6T_06760': 471.6, '1148.SYNGTS_2365': 462.9,
                           '944547.ABLL_2541': 398.7, '944546.ABED_1860': 389.6},
               'COG0018': {'1089456.NCGM2_0461': 591.2, '1037409.BJ6T_49620': 586.3, '1148.SYNGTS_2870': 568.1,
                           '944547.ABLL_2612': 534.9, '944546.ABED_1924': 531.7},
               'COG0048': {'1037409.BJ6T_43820': 180.8, '1089456.NCGM2_5513': 180.1, '1148.SYNGTS_1749': 179.1,
                           '944546.ABED_1798': 173.1, '944547.ABLL_2421': 173.1},
               'COG0049': {'1089456.NCGM2_5512': 246.6, '1148.SYNGTS_1748': 234.3, '944547.ABLL_2420': 233.2,
                           '944546.ABED_1797': 231.2, '1037409.BJ6T_43830': 217.6},
               'COG0052': {'1089456.NCGM2_4787': 407.6, '944546.ABED_0514': 390.8, '1037409.BJ6T_48500': 388.1,
                           '944547.ABLL_0659': 387.8, '1148.SYNGTS_1572': 387.7},
               'COG0080': {'1037409.BJ6T_43720': 262.3, '1148.SYNGTS_0845': 261.6, '1089456.NCGM2_5519': 256.0,
                           '944547.ABLL_2473': 234.6, '944546.ABED_1709': 231.7},
               'COG0081': {'1037409.BJ6T_43730': 335.9, '1089456.NCGM2_5518': 328.3, '944547.ABLL_2472': 325.3,
                           '944546.ABED_1708': 321.6, '1148.SYNGTS_0844': 316.2},
               'COG0085': {'1037409.BJ6T_43770': 2210.2, '1089456.NCGM2_5515': 2136.9, '1148.SYNGTS_0791': 2010.3,
                           '944546.ABED_1705': 1982.0, '944547.ABLL_2469': 1978.0, '944547.ABLL_2468': 1561.9,
                           '944546.ABED_1704': 1554.3, '1089456.NCGM2_5514': 898.8, '1037409.BJ6T_43780': 898.6,
                           '1148.SYNGTS_1691': 363.1, '1148.SYNGTS_0790': 322.4},
               'COG0086': {'1037409.BJ6T_43780': 1828.6, '1089456.NCGM2_5514': 1807.9, '944547.ABLL_2468': 1748.5,
                           '944546.ABED_1704': 1745.9, '1148.SYNGTS_1691': 878.7, '1148.SYNGTS_0790': 803.2},
               'COG0087': {'1089456.NCGM2_5508': 325.7, '1037409.BJ6T_43870': 312.8, '1148.SYNGTS_0775': 278.6,
                           '944546.ABED_0699': 144.8, '944547.ABLL_0974': 144.1},
               'COG0088': {'1148.SYNGTS_0774': 313.0, '1037409.BJ6T_43880': 286.7, '1089456.NCGM2_5507': 286.2,
                           '944546.ABED_0700': 244.9, '944547.ABLL_0975': 241.8},
               'COG0090': {'1148.SYNGTS_0772': 419.7, '1037409.BJ6T_43900': 414.1, '944546.ABED_0702': 407.1,
                           '944547.ABLL_0977': 406.4, '1089456.NCGM2_5505': 401.7},
               'COG0091': {'1148.SYNGTS_0770': 199.6, '1089456.NCGM2_5503': 163.9, '944546.ABED_0704': 160.2,
                           '944547.ABLL_0979': 159.1, '1037409.BJ6T_43920': 158.8},
               'COG0092': {'1089456.NCGM2_5502': 404.9, '1037409.BJ6T_43930': 403.0, '944546.ABED_0705': 377.9,
                           '944547.ABLL_0980': 377.7, '1148.SYNGTS_0769': 367.6},
               'COG0093': {'1089456.NCGM2_5498': 217.9, '1037409.BJ6T_43970': 216.8, '944546.ABED_0709': 209.1,
                           '944547.ABLL_0984': 208.9, '1148.SYNGTS_0765': 186.8},
               'COG0094': {'1089456.NCGM2_5496': 283.6, '1148.SYNGTS_0763': 281.7, '1037409.BJ6T_43990': 278.6,
                           '944546.ABED_0711': 228.1, '944547.ABLL_0986': 225.2},
               'COG0096': {'1037409.BJ6T_44010': 174.6, '1148.SYNGTS_0762': 172.3, '944546.ABED_0713': 157.0,
                           '944547.ABLL_0988': 156.5, '1089456.NCGM2_5494': 152.6},
               'COG0097': {'1148.SYNGTS_0761': 250.1, '1037409.BJ6T_44020': 245.3, '1089456.NCGM2_5493': 239.4,
                           '944546.ABED_0714': 215.9, '944547.ABLL_0989': 212.1},
               'COG0098': {'1037409.BJ6T_44040': 262.4, '1089456.NCGM2_5491': 251.1, '944546.ABED_0716': 229.4,
                           '944547.ABLL_0991': 229.4, '1148.SYNGTS_0759': 223.6},
               'COG0099': {'1089456.NCGM2_5486': 189.8, '1037409.BJ6T_44090': 189.6, '1148.SYNGTS_0753': 185.5,
                           '944546.ABED_0963': 181.9, '944547.ABLL_1774': 181.1},
               'COG0100': {'1037409.BJ6T_44100': 214.7, '1089456.NCGM2_5485': 211.7, '1148.SYNGTS_0752': 208.9,
                           '944547.ABLL_1773': 193.2, '944546.ABED_0964': 189.6},
               'COG0102': {'1089456.NCGM2_1170': 217.6, '1148.SYNGTS_0748': 211.9, '1037409.BJ6T_47250': 201.5,
                           '944546.ABED_0094': 185.5, '944547.ABLL_0247': 184.8},
               'COG0103': {'1037409.BJ6T_47260': 235.5, '1148.SYNGTS_0747': 206.8, '944546.ABED_0095': 197.6,
                           '944547.ABLL_0246': 196.2, '1089456.NCGM2_1171': 158.7},
               'COG0124': {'1089456.NCGM2_4989': 530.1, '1148.SYNGTS_2208': 523.3, '1037409.BJ6T_18330': 505.1,
                           '944547.ABLL_1218': 475.5, '944546.ABED_0911': 468.7, '1148.SYNGTS_2996': 196.4,
                           '1037409.BJ6T_17670': 146.2, '1089456.NCGM2_0581': 136.9, '944546.ABED_0071': 67.6,
                           '944547.ABLL_0268': 63.9},
               'COG0172': {'1089456.NCGM2_3628': 656.4, '1037409.BJ6T_49700': 609.6, '944547.ABLL_0481': 579.7,
                           '1148.SYNGTS_0652': 574.7, '944546.ABED_0320': 567.6, '944547.ABLL_0268': 63.9,
                           '944546.ABED_0071': 63.6},
               'COG0184': {'1089456.NCGM2_0797': 132.6, '944547.ABLL_0499': 121.5, '1037409.BJ6T_07840': 120.0,
                           '944546.ABED_0345': 118.3, '1148.SYNGTS_0306': 116.6},
               'COG0185': {'1148.SYNGTS_0771': 170.3, '1089456.NCGM2_5504': 165.2, '944547.ABLL_0978': 157.8,
                           '944546.ABED_0703': 157.2, '1037409.BJ6T_43910': 150.7},
               'COG0186': {'1089456.NCGM2_5499': 149.2, '1148.SYNGTS_0766': 131.3, '1037409.BJ6T_43960': 129.8,
                           '944546.ABED_0708': 105.0, '944547.ABLL_0983': 103.7},
               'COG0197': {'1148.SYNGTS_0768': 226.3, '1037409.BJ6T_43940': 202.8, '944547.ABLL_0981': 197.6,
                           '944546.ABED_0706': 197.1, '1089456.NCGM2_5501': 195.8},
               'COG0200': {'1037409.BJ6T_44060': 186.4, '1148.SYNGTS_0758': 186.0, '1089456.NCGM2_5489': 160.8,
                           '944546.ABED_0717': 127.4, '944547.ABLL_0992': 123.6},
               'COG0201': {'1037409.BJ6T_44070': 544.8, '1089456.NCGM2_5488': 536.8, '1148.SYNGTS_0757': 467.1,
                           '944546.ABED_0718': 447.2, '944547.ABLL_0993': 446.6},
               'COG0202': {'1037409.BJ6T_44110': 440.9, '1089456.NCGM2_5483': 427.8, '1148.SYNGTS_0751': 364.5,
                           '944547.ABLL_1771': 299.5, '944546.ABED_0966': 298.6},
               'COG0215': {'1089456.NCGM2_2699': 749.6, '1148.SYNGTS_1850': 666.0, '1037409.BJ6T_60740': 632.7,
                           '944546.ABED_0227': 608.6, '944547.ABLL_0379': 583.6, '1148.SYNGTS_2408': 61.2},
               'COG0256': {'1148.SYNGTS_0760': 189.3, '1089456.NCGM2_5492': 182.3, '1037409.BJ6T_44030': 180.4,
                           '944547.ABLL_0990': 135.3, '944546.ABED_0715': 131.0},
               'COG0495': {'1089456.NCGM2_5187': 1288.3, '1148.SYNGTS_0727': 1256.6, '1037409.BJ6T_05950': 1139.6,
                           '944546.ABED_0377': 1107.7, '944547.ABLL_0532': 1100.3, '944547.ABLL_0703': 281.3,
                           '1037409.BJ6T_52700': 280.7, '1089456.NCGM2_5023': 280.2, '944546.ABED_0537': 277.9,
                           '1148.SYNGTS_2918': 277.0, '1148.SYNGTS_0971': 257.8, '1089456.NCGM2_1036': 199.4,
                           '944546.ABED_0486': 195.4, '944547.ABLL_0649': 195.0, '1037409.BJ6T_18080': 164.9,
                           '1037409.BJ6T_52150': 136.3, '944547.ABLL_1549': 128.8, '944546.ABED_1143': 125.9,
                           '1148.SYNGTS_2408': 108.0, '1037409.BJ6T_83400': 84.1, '1089456.NCGM2_4622': 78.3},
               'COG0522': {'1089456.NCGM2_5484': 296.6, '944547.ABLL_1772': 286.2, '944546.ABED_0965': 285.1,
                           '1037409.BJ6T_40230': 270.2, '1148.SYNGTS_2341': 259.9},
               'COG0525': {'1148.SYNGTS_2918': 1455.6, '1089456.NCGM2_5023': 1434.7, '1037409.BJ6T_52700': 1409.4,
                           '944546.ABED_0537': 1272.1, '944547.ABLL_0703': 1270.7, '1148.SYNGTS_0971': 560.6,
                           '944546.ABED_0486': 498.6, '944547.ABLL_0649': 492.5, '1089456.NCGM2_1036': 458.4,
                           '1037409.BJ6T_18080': 409.6, '1148.SYNGTS_0727': 344.6, '1089456.NCGM2_5187': 317.5,
                           '1037409.BJ6T_05950': 312.8, '944546.ABED_0377': 270.8, '944547.ABLL_0532': 265.6,
                           '1148.SYNGTS_2408': 115.8, '1037409.BJ6T_52150': 112.9, '944547.ABLL_1549': 111.7,
                           '944546.ABED_1143': 107.3},
               'COG0533': {'1089456.NCGM2_5607': 610.8, '1148.SYNGTS_1534': 574.0, '1037409.BJ6T_05380': 550.6,
                           '944547.ABLL_0279': 496.9, '944546.ABED_0155': 493.3},
               'COG0541': {'1089456.NCGM2_4879': 770.6, '1037409.BJ6T_04500': 728.8, '1148.SYNGTS_1731': 716.6,
                           '944547.ABLL_2406': 581.5, '944546.ABED_1783': 573.1, '1089456.NCGM2_5826': 313.9,
                           '1148.SYNGTS_1420': 288.1, '1037409.BJ6T_04420': 288.0, '944546.ABED_0841': 257.1,
                           '944547.ABLL_1126': 252.8, '944546.ABED_1758': 84.0, '944547.ABLL_2379': 81.7,
                           '1089456.NCGM2_2337': 71.0},
               'COG0552': {'1089456.NCGM2_5826': 454.6, '1037409.BJ6T_04420': 397.1, '1148.SYNGTS_1420': 394.6,
                           '944547.ABLL_1126': 352.7, '944546.ABED_0841': 352.4, '1089456.NCGM2_4879': 287.9,
                           '1148.SYNGTS_1731': 279.7, '944547.ABLL_2406': 269.8, '944546.ABED_1783': 262.1,
                           '1037409.BJ6T_04500': 247.2, '944546.ABED_1758': 98.9, '944547.ABLL_2379': 96.6,
                           '1089456.NCGM2_2337': 71.0}}
    cutoffs = {'COG0012': 60, 'COG0016': 60, 'COG0018': 60, 'COG0048': 60, 'COG0049': 60, 'COG0052': 60, 'COG0080': 60,
     'COG0081': 60, 'COG0085': 60, 'COG0086': 60, 'COG0087': 60, 'COG0088': 60, 'COG0090': 60, 'COG0091': 60,
     'COG0092': 60, 'COG0093': 60, 'COG0094': 60, 'COG0096': 60, 'COG0097': 60, 'COG0098': 60, 'COG0099': 60,
     'COG0100': 60, 'COG0102': 60, 'COG0103': 60, 'COG0124': 60, 'COG0172': 60, 'COG0184': 60, 'COG0185': 60,
     'COG0186': 60, 'COG0197': 60, 'COG0200': 60, 'COG0201': 60, 'COG0202': 60, 'COG0215': 60, 'COG0256': 60,
     'COG0495': 60, 'COG0522': 60, 'COG0525': 60, 'COG0533': 60, 'COG0541': 60, 'COG0552': 60}

    with tempfile.TemporaryDirectory() as tmpdirname:
        args.o = tmpdirname
        args.map = os.path.join(TEST_INPUT_DIR, 'known_positives.map')
        assert fetchmgs.calibration(args, results, hmms, cutoffs) == \
           {'COG0012': [510, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0016': [380, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0018': [530, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0048': [170, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0049': [210, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0052': [380, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0080': [230, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0081': [310, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0085': [1970, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0086': [870, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0087': [140, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0088': [240, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0090': [400, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0091': [150, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0092': [360, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0093': [180, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0094': [220, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0096': [150, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0097': [210, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0098': [220, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0099': [180, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0100': [180, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0102': [180, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0103': [150, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0124': [460, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0172': [560, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0184': [110, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0185': [150, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0186': [100, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0197': [190, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0200': [120, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0201': [440, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0202': [290, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0215': [580, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0256': [130, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0495': [1100, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0522': [250, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0525': [1270, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0533': [490, 5, 0, 0, 1.0, 1.0, 1.0], 'COG0541': [570, 5, 0, 0, 1.0, 1.0, 1.0],
            'COG0552': [350, 5, 0, 0, 1.0, 1.0, 1.0]}


